name: Update dist branch

on:
  workflow_run:
    workflows: ["Create Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name (e.g., v0.7.0)'
        required: true
        type: string

jobs:
  update-dist:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update dist branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="${{ inputs.tag || github.event.workflow_run.head_branch }}"
          # Get getoptlong.sh from the release tag
          git show "${TAG}:script/getoptlong.sh" > /tmp/getoptlong.sh

          # Switch to dist branch
          git checkout dist

          # Update the file
          cp /tmp/getoptlong.sh getoptlong.sh

          # Commit and push if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add getoptlong.sh
            git commit -m "Update getoptlong.sh from ${TAG}"
            git push origin dist
          fi

      - name: Update major version branch
        run: |
          TAG="${{ inputs.tag || github.event.workflow_run.head_branch }}"
          # Extract major version (v1.2.3 -> v1)
          if [[ "$TAG" =~ ^v([0-9]+)\. ]]; then
            MAJOR="v${BASH_REMATCH[1]}"
            echo "Updating major version branch: $MAJOR"

            # Check if branch exists on remote
            if git ls-remote --exit-code --heads origin "$MAJOR" > /dev/null 2>&1; then
              # Branch exists, update it
              git checkout "$MAJOR"
              cp /tmp/getoptlong.sh getoptlong.sh
              if git diff --quiet; then
                echo "No changes to commit on $MAJOR"
              else
                git add getoptlong.sh
                git commit -m "Update getoptlong.sh from $TAG"
                git push origin "$MAJOR"
              fi
            else
              # Branch doesn't exist, create from dist
              git checkout -b "$MAJOR" dist
              git push origin "$MAJOR"
              echo "Created new branch: $MAJOR"
            fi
          else
            echo "Tag $TAG does not match vX.Y.Z pattern, skipping"
          fi
